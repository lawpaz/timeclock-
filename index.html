<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TimeClock — Desktop Only</title>
<style>
  :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444; --border:#1f2937; }
  * { box-sizing:border-box; }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:linear-gradient(120deg,#0b1023,#0f172a 35%,#0b1023); color:var(--text); }
  header { padding:18px 16px; display:flex; gap:14px; align-items:center; justify-content:space-between; max-width:1200px; margin:0 auto; }
  header h1 { margin:0; font-size:18px; font-weight:700; }
  .container { max-width:1200px; margin:0 auto; padding:0 16px 40px; display:grid; grid-template-columns: 1fr; gap:18px; }
  .card { background:rgba(17,24,39,.78); backdrop-filter:blur(8px); border:1px solid var(--border); border-radius:14px; padding:16px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  label { font-size:12px; color:var(--muted); }
  input,select { background:#0b1220; border:1px solid var(--border); color:var(--text); border-radius:10px; height:40px; padding:0 12px; outline:none; }
  input::placeholder { color:#70809a; }
  button { height:40px; padding:0 14px; border-radius:10px; border:1px solid transparent; color:white; font-weight:600; cursor:pointer; }
  button:disabled { opacity:.55; cursor:not-allowed; }
  .btn-primary{ background:var(--accent2); } .btn-go{ background:var(--accent); } .btn-warn{ background:var(--warn); color:#111; } .btn-danger{ background:var(--danger); }
  .btn-ghost{ background:transparent; border-color:#2a364a; color:#c7d2fe; }
  .pill{ padding:6px 10px; border-radius:999px; background:#0b1220; border:1px solid var(--border); color:var(--muted); font-size:12px; }
  .stat{ display:flex; flex-direction:column; gap:4px; padding:10px 12px; border:1px dashed #253048; border-radius:12px; min-width:140px; }
  .stat .k{ font-size:18px; font-weight:700; } .stat .t{ font-size:11px; color:var(--muted); }
  table{ width:100%; border-collapse:collapse; } th,td{ border-bottom:1px solid #1c2640; padding:10px 8px; text-align:left; font-size:14px; }
  th{ color:#aab3c6; font-weight:700; font-size:12px; text-transform:uppercase; }
  .right{ text-align:right; } .grow{ flex:1; } .hint{ font-size:12px; color:var(--muted); }
  .footer{ padding:12px 16px; color:#9aa6bf; font-size:12px; text-align:center; }
  .tabs{ display:flex; gap:6px; margin-bottom:10px; } .tab{ background:#0b1220; border:1px solid var(--border); border-radius:999px; padding:6px 12px; cursor:pointer; color:#cbd5e1; }
  .tab.active{ background:#1a2338; color:#fff; }
  .hidden{ display:none !important; }
  .badge{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #2a364a; color:#9aa6bf; }
  .nametabs { display:flex; gap:6px; overflow:auto; padding-bottom:4px; }
  .nametabs button { white-space:nowrap; }
  .period-nav { display:flex; gap:8px; align-items:center; }
</style>
</head>
<body>
<header>
  <h1>⏱️ TimeClock — Desktop Only</h1>
  <div class="row">
    <span id="now" class="pill">—</span>
    <button id="btnExport" class="btn-ghost hidden">Export CSV</button>
    <button id="btnSignOut" class="btn-danger hidden">Sign Out</button>
  </div>
</header>

<!-- AUTH -->
<div id="auth" class="container">
  <section class="card">
    <div class="tabs">
      <button class="tab active" data-tab="signin">Sign In</button>
      <button class="tab" data-tab="signup">Sign Up</button>
      <div class="grow"></div>
      <span class="badge">Home-office friendly (no geofence)</span>
    </div>

    <div id="signin" class="row" style="gap:12px;">
      <div class="grow">
        <label for="siEmail">Email or Username</label>
        <input id="siEmail" placeholder="email@company.com or username" />
      </div>
      <div class="grow">
        <label for="siPass">Password</label>
        <input id="siPass" type="password" placeholder="••••••••" />
      </div>
      <div><label>&nbsp;</label><button id="btnSignIn" class="btn-primary">Sign In</button></div>
      <div class="grow"></div>
      <div><label>&nbsp;</label><button id="btnReset" class="btn-ghost">Forgot password?</button></div>
      <div class="grow"></div>
      <div id="siMsg" class="hint"></div>
    </div>

    <div id="signup" class="row hidden" style="gap:12px;">
      <div class="grow">
        <label for="suFirst">First Name</label>
        <input id="suFirst" placeholder="e.g., Maria" />
      </div>
      <div class="grow">
        <label for="suLast">Last Name</label>
        <input id="suLast" placeholder="e.g., Lopez" />
      </div>
      <div class="grow">
        <label for="suUsername">Username (3–20 letters/numbers/_)</label>
        <input id="suUsername" placeholder="e.g., mlopez" />
      </div>
      <div class="grow">
        <label for="suEmail">Work Email</label>
        <input id="suEmail" placeholder="name@company.com" />
      </div>
      <div class="grow">
        <label for="suPass">Password</label>
        <input id="suPass" type="password" placeholder="At least 8 characters" />
      </div>
      <div><label>&nbsp;</label><button id="btnSignUp" class="btn-primary">Create account</button></div>
      <div class="grow"></div>
      <div id="suMsg" class="hint"></div>
    </div>
  </section>
</div>

<!-- APP -->
<div id="app" class="container hidden">
  <!-- Top status -->
  <section class="card">
    <div class="row" style="gap:12px; margin-bottom:10px;">
      <div class="grow">
        <div class="row" style="align-items:baseline; gap:8px;">
          <h3 style="margin:0; font-size:18px;" id="welcome">Welcome</h3>
          <span id="roleBadge" class="badge hidden">Admin</span>
          <span id="activeBadge" class="badge hidden">Inactive</span>
        </div>
        <div class="hint">Clocking is allowed from approved desktop/laptop only.</div>
      </div>
      <div class="period-nav">
        <button id="btnPrevPeriod" class="btn-ghost">◀</button>
        <span id="periodLbl" class="pill">Period: —</span>
        <button id="btnNextPeriod" class="btn-ghost">▶</button>
      </div>
    </div>

    <div class="row" style="gap:12px; margin:12px 0 2px;">
      <div class="stat"><div class="k" id="status">Not clocked in</div><div class="t">Current status</div></div>
      <div class="stat"><div class="k" id="since">—</div><div class="t">Since</div></div>
      <div class="stat"><div class="k" id="todayTotal">0h 00m</div><div class="t">Today total</div></div>
      <div class="grow"></div>
      <button id="btnIn" class="btn-go">Clock In</button>
      <button id="btnOut" class="btn-warn" disabled>Clock Out</button>
    </div>
    <div id="msg" class="hint"></div>
  </section>

  <!-- Add Entry (admin) -->
  <section id="addEntryCard" class="card hidden">
    <h3 style="margin:0 0 8px; font-size:16px;">Add Entry</h3>
    <div class="row" style="gap:8px;">
      <div class="grow">
        <label>User</label>
        <select id="aeUser"></select>
      </div>
      <div>
        <label>Date</label>
        <input id="aeDate" type="date" />
      </div>
      <div>
        <label>Clock In</label>
        <input id="aeIn" type="time" step="60" value="09:00" />
      </div>
      <div>
        <label>Clock Out</label>
        <input id="aeOut" type="time" step="60" value="17:00" />
      </div>
      <div>
        <label>Day Type</label>
        <select id="aeDay">
          <option>Work Day</option>
          <option>Holiday</option>
          <option>Sick</option>
          <option>PTO</option>
        </select>
      </div>
      <div><label>&nbsp;</label><button id="aeSave" class="btn-primary">Save</button></div>
      <div><label>&nbsp;</label><button id="aeCancel" class="btn-ghost">Cancel</button></div>
    </div>
  </section>

  <!-- Entries -->
  <section class="card">
    <div class="row" style="justify-content:space-between; margin-bottom:8px;">
      <h3 style="margin:0; font-size:16px;">Entries (current period)</h3>
      <div class="row">
        <div id="nameTabs" class="nametabs hidden"></div>
        <button id="btnShowAddEntry" class="btn-ghost hidden">Add Entry</button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Date</th>
          <th>Clock In</th>
          <th>Clock Out</th>
          <th>Day</th>
          <th class="right">Actions</th>
        </tr>
      </thead>
      <tbody id="entryRows"></tbody>
    </table>
  </section>

  <!-- Admin: Staff + Reports -->
  <section id="admin" class="card hidden">
    <div class="tabs">
      <button class="tab active" data-admin-tab="staff">Staff</button>
      <button class="tab" data-admin-tab="reports">Reports</button>
    </div>

    <!-- Staff -->
    <div id="admin-staff">
      <table>
        <thead><tr><th>First</th><th>Last</th><th>Username</th><th>Email</th><th>Status</th><th class="right">Actions</th></tr></thead>
        <tbody id="staffRows"></tbody>
      </table>
    </div>

    <!-- Reports -->
    <div id="admin-reports" class="hidden">
      <div class="row" style="gap:10px; margin-bottom:10px;">
        <button id="btnGenerateNow" class="btn-primary">Generate Now (biweekly Mon–Sat)</button>
        <button id="btnLoadLatest" class="btn-ghost">Load Latest</button>
        <button id="btnExportTotals" class="btn-ghost">Export CSV</button>
      </div>
      <div class="hint" id="reportRange"></div>
      <table>
        <thead><tr><th>Name</th><th>Date</th><th>Clock In</th><th>Clock Out</th><th class="right">Daily Hours</th></tr></thead>
        <tbody id="reportRows"></tbody>
      </table>

      <h4 style="margin:16px 0 6px;">Saved reports</h4>
      <table>
        <thead><tr><th>Start</th><th>End</th><th>Generated</th><th class="right">Actions</th></tr></thead>
        <tbody id="reportList"></tbody>
      </table>
    </div>
  </section>
</div>

<div class="footer">Desktop-only. Data stored in Firebase.</div>

<!-- Firebase logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, addDoc, collection, query, where, onSnapshot, getDocs, serverTimestamp, updateDoc, deleteDoc, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  /* ===== Config (your Firebase project) ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyCAi1zcDsdprr78A5RdYiOhz6Xn8Oiz54s",
    authDomain: "timeclock-15ac7.firebaseapp.com",
    projectId: "timeclock-15ac7",
    storageBucket: "timeclock-15ac7.firebasestorage.app",
    messagingSenderId: "469697538798",
    appId: "1:469697538798:web:5f6333835de2523bdba1ff",
    measurementId: "G-RTW4RDNZHC"
  };

  /* ===== Init ===== */
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /* ===== Helpers ===== */
  function $(s){ return document.querySelector(s); }
  function $all(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
  function pad2(n){ n = Math.round(n); return (n<10?'0':'')+n; }
  function fmt2(n){ return (Math.round(n*100)/100).toFixed(2); }
  function hmNoLead(d){ return String(d.getHours()) + ':' + pad2(d.getMinutes()); }
  function dateKey(d){ return d.toISOString().slice(0,10); }
  function mdy(d){ return d.toLocaleDateString(undefined,{ month:'short', day:'numeric', year:'numeric' }); }
  function show(el, v){ el.classList.toggle('hidden', !v); }
  function fullNameOf(u){ var a=[]; if(u && u.firstName){ a.push(u.firstName); } if(u && u.lastName){ a.push(u.lastName); } return a.join(' ').trim(); }
  function todayISO(){ return new Date().toISOString().slice(0,10); }

  var msg = $('#msg');

  /* Desktop-only guard */
  (function(){
    var ua = (navigator.userAgent||'').toLowerCase();
    var mobile = /android|iphone|ipad|ipod|iemobile|blackberry|opera mini/.test(ua);
    var touch = (navigator.maxTouchPoints||0) > 0;
    var small = Math.min(screen.width, screen.height) < 800;
    var iPadAsMac = (navigator.platform||'').toLowerCase().indexOf('mac')>=0 && touch;
    if (mobile || iPadAsMac || (touch && small)) {
      document.body.innerHTML = '<div style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#0f172a; color:#e5e7eb; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;"><div style="max-width:560px; background:#111827; border:1px solid #1f2937; border-radius:12px; padding:20px;"><h2 style="margin:0 0 8px;">Desktop Required</h2><p>Please use a desktop or laptop computer to access the time clock.</p></div></div>';
      throw new Error('Blocked mobile/tablet');
    }
  })();

  /* Clock */
  var nowEl = $('#now'); setInterval(function(){ nowEl.textContent = new Date().toLocaleString(); }, 1000);

  /* Auth tabs */
  $all('.tab[data-tab]').forEach(function(b){
    b.addEventListener('click',function(){
      $all('.tab[data-tab]').forEach(function(x){ x.classList.remove('active'); });
      b.classList.add('active');
      show($('#signin'), b.getAttribute('data-tab')==='signin');
      show($('#signup'), b.getAttribute('data-tab')==='signup');
    });
  });

  /* Admin tabs */
  $all('.tab[data-admin-tab]').forEach(function(b){
    b.addEventListener('click',function(){
      $all('.tab[data-admin-tab]').forEach(function(x){ x.classList.remove('active'); });
      b.classList.add('active');
      show($('#admin-staff'), b.getAttribute('data-admin-tab')==='staff');
      show($('#admin-reports'), b.getAttribute('data-admin-tab')==='reports');
      if (b.getAttribute('data-admin-tab')==='reports'){ loadLatestReport(); loadAllReports(); }
    });
  });

  /* UI refs */
  var siEmail=$('#siEmail'), siPass=$('#siPass'), siMsg=$('#siMsg');
  var suFirst=$('#suFirst'), suLast=$('#suLast'), suUsername=$('#suUsername'), suEmail=$('#suEmail'), suPass=$('#suPass'), suMsg=$('#suMsg');
  var btnSignIn=$('#btnSignIn'), btnReset=$('#btnReset'), btnSignUp=$('#btnSignUp');
  var btnSignOut=$('#btnSignOut'), btnExport=$('#btnExport');
  var welcome=$('#welcome'), roleBadge=$('#roleBadge'), activeBadge=$('#activeBadge');
  var statusEl=$('#status'), sinceEl=$('#since');
  var btnIn=$('#btnIn'), btnOut=$('#btnOut');
  var periodLbl=$('#periodLbl'), btnPrevPeriod=$('#btnPrevPeriod'), btnNextPeriod=$('#btnNextPeriod']);
  var entryRows=$('#entryRows'); var nameTabs = $('#nameTabs'); var btnShowAddEntry=$('#btnShowAddEntry');
  var addEntryCard=$('#addEntryCard'), aeUser=$('#aeUser'), aeDate=$('#aeDate'), aeIn=$('#aeIn'), aeOut=$('#aeOut'), aeDay=$('#aeDay'), aeSave=$('#aeSave'), aeCancel=$('#aeCancel');
  var adminSection=$('#admin'), staffRows=$('#staffRows');
  var reportRows=$('#reportRows'), reportRange=$('#reportRange'), btnLoadLatest=$('#btnLoadLatest'), btnGenerateNow=$('#btnGenerateNow'), btnExportTotals=$('#btnExportTotals'), reportList=$('#reportList');

  /* State */
  var state = { user:null, isAdmin:false, me:null, users:new Map(), currentStatus:'out', filterUid:null, period:null, periodOffset:0, liveUnsub:null, earliestPunch:null };

  function validUsername(u){ return /^[a-z0-9_]{3,20}$/.test(u||''); }
  async function resolveLoginIdentifier(idOrUsername){
    if(!idOrUsername) throw new Error('Enter email or username.');
    if(idOrUsername.indexOf('@')>=0) return idOrUsername.trim().toLowerCase();
    var uname=idOrUsername.trim().toLowerCase();
    var s=await getDoc(doc(db,'usernames', uname)); if(!s.exists()) throw new Error('Username not found.');
    var data=s.data(); if(!data.email) throw new Error('Username has no email.');
    return String(data.email).toLowerCase();
  }

  /* Sign-in/up */
  btnSignIn.addEventListener('click', async function(){ siMsg.textContent=''; try{ var email=await resolveLoginIdentifier(siEmail.value); await signInWithEmailAndPassword(auth,email,siPass.value);}catch(e){ siMsg.textContent='Sign-in failed: '+e.message; alert('Sign-in failed: '+e.message);} });
  btnReset.addEventListener('click', async function(){ siMsg.textContent=''; try{ var email=await resolveLoginIdentifier(siEmail.value); await sendPasswordResetEmail(auth,email); siMsg.textContent='Reset email sent if the account exists.';}catch(e){ siMsg.textContent='Password reset failed: '+e.message; alert('Password reset failed: '+e.message);} });
  btnSignUp.addEventListener('click', async function(){ suMsg.textContent=''; try{
    var firstName=suFirst.value.trim(), lastName=suLast.value.trim(); if(!firstName||!lastName) throw new Error('Enter first and last name.');
    var username=suUsername.value.trim().toLowerCase(); if(!validUsername(username)) throw new Error('Username must be 3–20 letters/numbers/_');
    var email=suEmail.value.trim().toLowerCase(); var pass=suPass.value; if(pass.length<8) throw new Error('Password must be at least 8 characters.');
    var exists=await getDoc(doc(db,'usernames',username)); if(exists.exists()) throw new Error('Username is taken.');
    var cred=await createUserWithEmailAndPassword(auth,email,pass); await updateProfile(cred.user,{displayName:username});
    await setDoc(doc(db,'users',cred.user.uid),{ username:username,email:email,firstName:firstName,lastName:lastName,role:'staff',active:false,createdAt:serverTimestamp() });
    await setDoc(doc(db,'usernames',username),{ uid:cred.user.uid, email:email });
    suMsg.textContent='Account created. Admin must activate your account.';
  }catch(e){ suMsg.textContent='Sign-up failed: '+e.message; alert('Sign-up failed: '+e.message); }});
  btnSignOut.addEventListener('click', async function(){ await signOut(auth); });

  /* Roles */
  async function isAdmin(uid){ var s=await getDoc(doc(db,'admins',uid)); return s.exists(); }
  async function ensureUserDoc(user){
    var ref=doc(db,'users', user.uid), s=await getDoc(ref);
    if(!s.exists()) await setDoc(ref, { username:user.displayName||'', email:user.email, role:'staff', active:false, createdAt:serverTimestamp() });
    var data=(await getDoc(ref)).data(); state.users.set(user.uid,data); return data;
  }

  /* Period helpers (biweekly Mon–Sat x2) */
  function lastSaturdayEnd(d){ if(!d) d=new Date(); var dow=d.getDay(); var days=(dow-6+7)%7; var x=new Date(d); x.setDate(x.getDate()-days); x.setHours(23,59,59,999); return x; }
  function startFromEndSat(end){ var x=new Date(end); x.setDate(x.getDate()-12); x.setHours(0,0,0,0); return x; }
  function periodByOffset(offset){ var end0=lastSaturdayEnd(new Date()); var end=new Date(end0); end.setDate(end.getDate()+offset*14); var start=startFromEndSat(end); return {start:start,end:end}; }
  async function earliestPunchDate(){ if(state.earliestPunch) return state.earliestPunch; var s=await getDocs(query(collection(db,'punches'), orderBy('ts','asc'), limit(1))); state.earliestPunch = s.empty? null : s.docs[0].data().ts.toDate(); return state.earliestPunch; }
  async function updatePeriodNav(){
    btnNextPeriod.disabled = state.periodOffset >= 0;
    var ep = await earliestPunchDate(); if(!ep){ btnPrevPeriod.disabled = true; return; }
    var earliestStart = startFromEndSat(lastSaturdayEnd(ep));
    btnPrevPeriod.disabled = state.period.start <= earliestStart;
  }

  function renderAuth(signed){
    show($('#auth'),!signed); show($('#app'),!!signed); show(btnSignOut,!!signed);
    show(btnExport, signed && state.isAdmin);
  }

  onAuthStateChanged(auth, async function(user){
    state.user=user||null; if(!user){ if(state.liveUnsub) state.liveUnsub(); renderAuth(false); return; }
    state.isAdmin = await isAdmin(user.uid);
    state.me = await ensureUserDoc(user);
    var nm = fullNameOf(state.me) || state.me && (state.me.username||'') || user.email;
    welcome.textContent = 'Welcome, ' + nm;
    show(roleBadge, state.isAdmin); show(activeBadge, !(state.me&&state.me.active));
    show(adminSection, state.isAdmin);
    renderAuth(true);

    show(nameTabs, state.isAdmin);
    show(btnShowAddEntry, state.isAdmin);
    show(addEntryCard, false);

    state.periodOffset = 0;
    state.period = periodByOffset(0);
    periodLbl.textContent = 'Period: ' + mdy(state.period.start) + ' – ' + mdy(state.period.end);
    await updatePeriodNav();

    state.filterUid = state.isAdmin ? null : user.uid;
    if (state.isAdmin) { wireNameTabs(); loadStaff(); loadUsersForAddEntry(); }
    subscribeEntries();
    recomputeStatus();
  });

  /* Strict IN→OUT */
  async function lastPunch(uid){
    var q1=query(collection(db,'punches'), where('uid','==',uid), orderBy('ts','desc'), limit(1));
    var s=await getDocs(q1); return s.empty?null:{ id:s.docs[0].id, data:s.docs[0].data() };
  }
  async function recomputeStatus(){
    var last=await lastPunch(state.user.uid);
    if(!last || last.data.type==='out'){
      state.currentStatus='out'; statusEl.textContent='Not clocked in'; btnIn.disabled=!(state.isAdmin||(state.me&&state.me.active)); btnOut.disabled=true; sinceEl.textContent='—';
    } else {
      state.currentStatus='in'; statusEl.textContent='Clocked in'; btnIn.disabled=true; btnOut.disabled=false; var t=(last.data.ts&&last.data.ts.toDate)?last.data.ts.toDate():new Date(); sinceEl.textContent=t.toLocaleString();
    }
  }
  async function doPunch(type){
    msg.textContent='';
    try{
      var last=await lastPunch(state.user.uid);
      if(type==='in'){ if (last && last.data.type==='in') throw new Error('Already clocked in. Please clock out first.'); }
      else { if (!last || last.data.type!=='in') throw new Error('You are not clocked in.'); }
      var me=state.me||{};
      await addDoc(collection(db,'punches'),{
        uid:state.user.uid, username:me.username||state.user.email, fullName:fullNameOf(me)||'', type:type,
        ts:serverTimestamp(), dayType:'Work Day', source:'desktop',
        ua:navigator.userAgent||'', screen:{w:screen.width,h:screen.height}
      });
      msg.textContent='Recorded ✓'; await recomputeStatus();
    }catch(e){ msg.textContent='Error: '+e.message; alert('Punch failed: '+e.message); }
  }
  $('#btnIn').addEventListener('click', function(){ doPunch('in'); });
  $('#btnOut').addEventListener('click', function(){ doPunch('out'); });

  /* Entries */
  function wireNameTabs(){
    nameTabs.innerHTML='';
    function make(id,label){
      var b=document.createElement('button');
      b.className='tab' + (state.filterUid===id?' active':'');
      b.textContent=label;
      b.addEventListener('click',function(){ state.filterUid=id; wireNameTabs(); buildEntries(); });
      nameTabs.appendChild(b);
    }
    make(null,'All');
    getDocs(collection(db,'users')).then(function(s){
      var arr=[]; s.forEach(function(d){ var x=d.data(); x.id=d.id; arr.push(x); });
      arr.sort(function(a,b){ var na=(fullNameOf(a)||a.username||'').toLowerCase(); var nb=(fullNameOf(b)||b.username||'').toLowerCase(); return na<nb?-1:na>nb?1:0; });
      arr.forEach(function(u){ make(u.id, fullNameOf(u)||u.username||u.email); });
    });
  }

  btnPrevPeriod.addEventListener('click', async function(){
    state.periodOffset -= 1;
    state.period = periodByOffset(state.periodOffset);
    periodLbl.textContent = 'Period: ' + mdy(state.period.start) + ' – ' + mdy(state.period.end);
    await updatePeriodNav(); buildEntries();
  });
  btnNextPeriod.addEventListener('click', async function(){
    if(state.periodOffset>=0) return;
    state.periodOffset += 1;
    state.period = periodByOffset(state.periodOffset);
    periodLbl.textContent = 'Period: ' + mdy(state.period.start) + ' – ' + mdy(state.period.end);
    await updatePeriodNav(); buildEntries();
  });

  function subscribeEntries(){
    if(state.liveUnsub) state.liveUnsub();
    var q1=query(collection(db,'punches'), orderBy('ts','asc'));
    state.liveUnsub = onSnapshot(q1, function(){ buildEntries(); });
    buildEntries();
  }

  function cellEditableAttr(kind, uid, dk){
    return ' data-k="'+kind+'" data-key="'+uid+'|'+dk+'" contenteditable="true"';
  }

  async function buildEntries(){
    var start=state.period.start, end=state.period.end;
    var snaps = await getDocs(query(collection(db,'punches'), orderBy('ts','asc')));

    var userMap = new Map();
    var us = await getDocs(collection(db,'users'));
    us.forEach(function(d){ var v=d.data(); userMap.set(d.id,{username:v.username||'', full: fullNameOf(v)||''}); });

    var byDay = new Map();
    var lastInPerUid = new Map();

    snaps.forEach(function(docu){
      var p=docu.data(); if(!p.ts||!p.ts.toDate) return;
      var when=p.ts.toDate(); if(when<start || when>end) return;
      if(!state.isAdmin && p.uid!==state.user.uid) return;
      if(state.filterUid && p.uid!==state.filterUid) return;

      var k=p.uid+'|'+dateKey(when);
      var rec=byDay.get(k) || { uid:p.uid, dateKey:dateKey(when), firstIn:null, lastOut:null, totalMins:0, dayType:p.dayType||'Work Day', docs:[] };
      rec.docs.push({ id:docu.id, type:p.type, ts:when });
      if(p.type==='in'){ if(!rec.firstIn || when<rec.firstIn) rec.firstIn=when; lastInPerUid.set(p.uid, {when:when, k:k}); }
      if(p.type==='out'){
        var li = lastInPerUid.get(p.uid);
        if(li && li.k===k){ rec.totalMins += (when - li.when)/60000; lastInPerUid.delete(p.uid); }
        if(!rec.lastOut || when>rec.lastOut) rec.lastOut=when;
      }
      byDay.set(k, rec);
    });

    var rows = Array.from(byDay.values()).sort(function(a,b){
      var an = (userMap.get(a.uid)&&userMap.get(a.uid).full) || (userMap.get(a.uid)&&userMap.get(a.uid).username) || a.uid;
      var bn = (userMap.get(b.uid)&&userMap.get(b.uid).full) || (userMap.get(b.uid)&&userMap.get(b.uid).username) || b.uid;
      an=an.toLowerCase(); bn=bn.toLowerCase();
      if(an!==bn) return an<bn?-1:1;
      return a.dateKey<b.dateKey?-1:1;
    });

    entryRows.innerHTML = '';
    if (rows.length===0){
      var tr0=document.createElement('tr'); tr0.innerHTML='<td colspan="6" class="hint">No entries in this period.</td>'; entryRows.appendChild(tr0); return;
    }

    rows.forEach(function(r){
      var nm = (userMap.get(r.uid)&&userMap.get(r.uid).full) || (userMap.get(r.uid)&&userMap.get(r.uid).username) || r.uid.slice(0,6);
      var d = new Date(r.dateKey+'T00:00:00');
      var tr=document.createElement('tr');

      var tdIn = '<td>' + (r.firstIn?hmNoLead(r.firstIn):'') + '</td>';
      var tdOut = '<td>' + (r.lastOut?hmNoLead(r.lastOut):'') + '</td>';
      var tdDay = '<td>' + (r.dayType||'Work Day') + '</td>';

      if(state.isAdmin){
        tdIn  = '<td'+cellEditableAttr('in', r.uid, r.dateKey)+'>' + (r.firstIn?hmNoLead(r.firstIn):'') + '</td>';
        tdOut = '<td'+cellEditableAttr('out', r.uid, r.dateKey)+'>' + (r.lastOut?hmNoLead(r.lastOut):'') + '</td>';
        tdDay = '<td'+cellEditableAttr('daytype', r.uid, r.dateKey)+'>' + (r.dayType||'Work Day') + '</td>';
      }

      var delBtn = state.isAdmin ? '<button class="btn-danger" data-del="'+r.uid+'|'+r.dateKey+'" style="height:32px;">Delete Day</button>' : '';
      tr.innerHTML =
        '<td>'+nm+'</td>' +
        '<td>'+mdy(d)+'</td>' +
        tdIn + tdOut + tdDay +
        '<td class="right">'+delBtn+'</td>';

      tr.dataset.docs = JSON.stringify(r.docs.map(function(x){ return {id:x.id,type:x.type,ts:x.ts}; }));
      entryRows.appendChild(tr);
    });

    /* Totals for single user (staff view or admin filtered) */
    var singleUser = !state.isAdmin || !!state.filterUid;
    if(singleUser){
      var minsWeek1=0, minsWeek2=0;
      var w1End=new Date(start); w1End.setDate(start.getDate()+5); w1End.setHours(23,59,59,999);
      rows.forEach(function(r){ var m=r.totalMins||0; var d=new Date(r.dateKey+'T00:00:00'); if(d<=w1End) minsWeek1+=m; else minsWeek2+=m; });
      var periodMins = minsWeek1+minsWeek2;
      function addRow(label,hrs){ var tr=document.createElement('tr'); tr.innerHTML='<td><strong>'+label+'</strong></td><td></td><td></td><td></td><td class="right"><strong>'+fmt2(hrs/60)+'</strong></td><td></td>'; entryRows.appendChild(tr); }
      addRow('Week Total (Mon–Sat, week 1)', minsWeek1);
      addRow('Week Total (Mon–Sat, week 2)', minsWeek2);
      addRow('Period Total', periodMins);
    }

    /* Editing (admin) */
    if(state.isAdmin){
      entryRows.querySelectorAll('[data-k="in"],[data-k="out"]').forEach(function(cell){
        cell.addEventListener('keydown', async function(e){
          if(e.key!=='Enter') return; e.preventDefault(); cell.blur();
          var kind=cell.getAttribute('data-k'); var tr=cell.closest('tr'); var docs=JSON.parse(tr.dataset.docs);
          var val=cell.textContent.trim(); if(!/^\d{1,2}:\d{2}$/.test(val)) return alert('Use H:MM (24h)');
          var target=null;
          if(kind==='in'){ var min=1e15; docs.forEach(function(d){ if(d.type==='in' && d.ts<min){ min=d.ts; target=d; } }); }
          else { var max=0; docs.forEach(function(d){ if(d.type==='out' && d.ts>max){ max=d.ts; target=d; } }); }
          if(!target) return alert('No '+(kind==='in'?'IN':'OUT')+' punch to edit.');
          var base=new Date(target.ts); var parts=val.split(':'); var h=Number(parts[0]); var m=Number(parts[1]); var t=new Date(dateKey(base)+'T'+pad2(h)+':'+pad2(m)+':00');
          await updateDoc(doc(db,'punches', target.id), { ts: Timestamp.fromDate(t) });
          msg.textContent=(kind==='in'?'Clock in':'Clock out')+' updated ✓';
        });
      });
      entryRows.querySelectorAll('[data-k="daytype"]').forEach(function(cell){
        cell.addEventListener('keydown', async function(e){
          if(e.key!=='Enter') return; e.preventDefault(); cell.blur();
          var val=cell.textContent.trim()||'Work Day'; var tr=cell.closest('tr'); var docs=JSON.parse(tr.dataset.docs);
          for(var i=0;i<docs.length;i++){ await updateDoc(doc(db,'punches', docs[i].id), { dayType: val }); }
          msg.textContent='Day type updated ✓';
        });
      });
      entryRows.querySelectorAll('[data-del]').forEach(function(btn){
        btn.addEventListener('click', async function(){
          if(!confirm('Delete ALL punches for this day?')) return;
          var row=btn.closest('tr'); var docs=JSON.parse(row.dataset.docs);
          for(var i=0;i<docs.length;i++){ await deleteDoc(doc(db,'punches', docs[i].id)); }
        });
      });
    }
  }

  /* Add Entry form (admin) */
  function loadUsersForAddEntry(){
    aeUser.innerHTML='';
    getDocs(collection(db,'users')).then(function(s){
      var arr=[]; s.forEach(function(d){ var x=d.data(); x.id=d.id; arr.push(x); });
      arr.sort(function(a,b){ var na=(fullNameOf(a)||a.username||'').toLowerCase(); var nb=(fullNameOf(b)||b.username||'').toLowerCase(); return na<nb?-1:na>nb?1:0; });
      arr.forEach(function(u){ var op=document.createElement('option'); op.value=u.id; op.textContent=fullNameOf(u)||u.username||u.email; aeUser.appendChild(op); });
    });
    aeDate.value = todayISO();
  }
  btnShowAddEntry.addEventListener('click', function(){ show(addEntryCard, true); });
  aeCancel.addEventListener('click', function(){ show(addEntryCard, false); });
  aeSave.addEventListener('click', async function(){
    if(!state.isAdmin) return;
    var uid=aeUser.value; if(!uid) return alert('Pick a user');
    var s=await getDoc(doc(db,'users', uid)); if(!s.exists()) return alert('User not found');
    var u=s.data(); var d=aeDate.value; var tIn=aeIn.value; var tOut=aeOut.value; var day=aeDay.value;
    if(!/^\d{4}-\d{2}-\d{2}$/.test(d)) return alert('Date required');
    if(!/^\d{2}:\d{2}$/.test(tIn)||!/^\d{2}:\d{2}$/.test(tOut)) return alert('Times must be HH:MM');
    var inDt=new Date(d+'T'+tIn+':00'); var outDt=new Date(d+'T'+tOut+':00'); if(outDt<=inDt) return alert('Out must be after In');
    await addDoc(collection(db,'punches'), { uid:uid, username:u.username||u.email, fullName:fullNameOf(u)||'', type:'in',  ts:Timestamp.fromDate(inDt),  dayType:day, source:'manual' });
    await addDoc(collection(db,'punches'), { uid:uid, username:u.username||u.email, fullName:fullNameOf(u)||'', type:'out', ts:Timestamp.fromDate(outDt), dayType:day, source:'manual' });
    alert('Entry added'); show(addEntryCard,false);
  });

  /* Staff list (admin) */
  function loadStaff(){
    onSnapshot(collection(db,'users'), function(s){
      staffRows.innerHTML='';
      s.forEach(function(d){
        var u=d.data(); u.id=d.id;
        var tr=document.createElement('tr');
        tr.innerHTML =
          '<td>'+(u.firstName||'')+'</td>'+
          '<td>'+(u.lastName||'')+'</td>'+
          '<td>'+(u.username||'')+'</td>'+
          '<td>'+(u.email||'')+'</td>'+
          '<td>'+(u.active?'Active':'Inactive')+'</td>'+
          '<td class="right">'+
            '<button class="btn-ghost" data-edit="'+u.id+'" style="height:32px;">Edit</button> '+
            '<button class="btn-ghost" data-act="'+u.id+'" style="height:32px;">'+(u.active?'Disable':'Activate')+'</button> '+
            '<button class="btn-danger" data-del="'+u.id+'" style="height:32px;">Delete</button>'+
          '</td>';
        staffRows.appendChild(tr);
      });

      staffRows.querySelectorAll('[data-act]').forEach(function(b){ b.addEventListener('click', async function(){ var id=b.getAttribute('data-act'); var s=await getDoc(doc(db,'users', id)); if(!s.exists()) return; await updateDoc(doc(db,'users', id), { active: !s.data().active }); }); });
      staffRows.querySelectorAll('[data-del]').forEach(function(b){ b.addEventListener('click', async function(){ var id=b.getAttribute('data-del'); if(!confirm('Delete this user profile? (Auth login remains)')) return; await deleteDoc(doc(db,'users', id)); }); });
      staffRows.querySelectorAll('[data-edit]').forEach(function(b){
        b.addEventListener('click', async function(){
          var id=b.getAttribute('data-edit'); var s=await getDoc(doc(db,'users', id)); if(!s.exists()) return; var uu=s.data();
          var first=prompt('First name:', uu.firstName||''); if(first===null) return;
          var last =prompt('Last name:',  uu.lastName||''); if(last===null) return;
          var uname=prompt('Username (3–20 letters/numbers/_):', uu.username||''); if(uname===null) return; uname=uname.trim().toLowerCase(); if(!/^[a-z0-9_]{3,20}$/.test(uname)) return alert('Invalid username');
          if(uname !== (uu.username||'')){
            var exists=await getDoc(doc(db,'usernames', uname)); if(exists.exists()) return alert('Username is taken.');
            var old=uu.username?uu.username.toLowerCase():''; if(old){ var oldDoc=await getDoc(doc(db,'usernames', old)); if(oldDoc.exists() && oldDoc.data().uid===id){ await deleteDoc(doc(db,'usernames', old)); } }
            await setDoc(doc(db,'usernames', uname), { uid:id, email: uu.email });
          }
          await updateDoc(doc(db,'users', id), { firstName:first, lastName:last, username:uname });
          alert('Updated.'); wireNameTabs();
        });
      });
    });
  }

  /* Reports */
  async function computeDailyRows(start,end){
    var usersSnap = await getDocs(collection(db,'users'));
    var nameByUid = new Map(); usersSnap.forEach(function(u){ var d=u.data(); nameByUid.set(u.id,{full: fullNameOf(d)||'', username:d.username||''}); });

    var snaps = await getDocs(query(collection(db,'punches'), orderBy('ts','asc')));
    var perDay = new Map(); var lastIn = new Map();
    snaps.forEach(function(d){
      var x=d.data(); if(!x.ts||!x.ts.toDate) return; var t=x.ts.toDate();
      if(t<start || t>end) return;
      var k=x.uid+'|'+dateKey(t);
      var item = perDay.get(k) || { uid:x.uid, date:new Date(dateKey(t)+'T00:00:00'), firstIn:null, lastOut:null, mins:0 };
      if(x.type==='in'){ if(!item.firstIn || t<item.firstIn) item.firstIn=t; lastIn.set(k,t); }
      if(x.type==='out'){ var li=lastIn.get(k); if(li){ item.mins += (t-li)/60000; lastIn.delete(k);} if(!item.lastOut || t>item.lastOut) item.lastOut=t; }
      perDay.set(k,item);
    });

    var rows = Array.from(perDay.values()).map(function(v){
      var nm=(nameByUid.get(v.uid)&&nameByUid.get(v.uid).full) || (nameByUid.get(v.uid)&&nameByUid.get(v.uid).username) || v.uid.slice(0,6);
      return { uid:v.uid, name:nm, date:v.date, in:v.firstIn?hmNoLead(v.firstIn):'', out:v.lastOut?hmNoLead(v.lastOut):'', mins:v.mins };
    }).sort(function(a,b){ var c=a.name.localeCompare(b.name); return c|| (a.date - b.date); });
    return rows;
  }

  async function generateAndSaveCurrentBiweekly(){
    var end = lastSaturdayEnd(new Date());
    var start = startFromEndSat(end);
    var rows = await computeDailyRows(start,end);
    await addDoc(collection(db,'reports'), { start: Timestamp.fromDate(start), end: Timestamp.fromDate(end), rows:rows, generatedAt: serverTimestamp() });
    await loadLatestReport(); await loadAllReports();
  }
  btnGenerateNow.addEventListener('click', generateAndSaveCurrentBiweekly);

  async function loadLatestReport(){
    var s = await getDocs(query(collection(db,'reports'), orderBy('end','desc'), limit(1)));
    if(s.empty){ reportRows.innerHTML=''; reportRange.textContent='No saved report yet. Click "Generate Now".'; return; }
    await renderReportDoc(s.docs[0]);
  }

  /* Fixed renderer: proper dates + one Week Total per week + PERIOD TOTAL */
  async function renderReportDoc(docu){
    var data = docu.data();
    var start = (data.start && data.start.toDate) ? data.start.toDate() : new Date(data.start);
    var end   = (data.end   && data.end.toDate)   ? data.end.toDate()   : new Date(data.end);
    var gen   = (data.generatedAt && data.generatedAt.toDate) ? data.generatedAt.toDate() : new Date();

    reportRange.textContent = 'Period: ' + mdy(start) + ' – ' + mdy(end) + ' (generated ' + gen.toLocaleString() + ')';

    var rows = (data.rows || []).map(function(r){
      var d = (r.date && r.date.toDate) ? r.date.toDate() : (typeof r.date === 'string' ? new Date(r.date) : new Date(r.date));
      return { name:r.name, date:d, in:r.in||'', out:r.out||'', mins:r.mins||0 };
    }).filter(function(r){ return !isNaN(r.date.getTime()); })
      .sort(function(a,b){ var c=a.name.localeCompare(b.name); return c || (a.date - b.date); });

    reportRows.innerHTML='';

    var curName=null, weekKey=null, weekMins=0, periodMins=0, weekIdx=0;

    function mondayKey(d){
      var dow=d.getDay();
      var m=new Date(d); m.setHours(0,0,0,0);
      m.setDate(d.getDate() - (dow===0 ? 6 : (dow-1)));
      return m.toISOString().slice(0,10);
    }
    function ordinal(n){ if(n===1) return '1st'; if(n===2) return '2nd'; if(n===3) return '3rd'; return n+'th'; }
    function flushWeekTotal(){
      if(weekKey===null) return;
      var tr=document.createElement('tr');
      tr.innerHTML='<td>'+curName+'</td><td><strong>'+ordinal(weekIdx)+' Week Total</strong></td><td></td><td></td><td class="right"><strong>'+fmt2(weekMins/60)+'</strong></td>';
      reportRows.appendChild(tr);
      weekKey=null; weekMins=0;
    }
    function flushPeriodTotal(){
      var tr=document.createElement('tr');
      tr.innerHTML='<td>'+curName+'</td><td><strong>PERIOD TOTAL</strong></td><td></td><td></td><td class="right"><strong>'+fmt2(periodMins/60)+'</strong></td>';
      reportRows.appendChild(tr);
      periodMins=0; weekIdx=0;
    }

    rows.forEach(function(r){
      if(r.name !== curName){
        if(curName){ flushWeekTotal(); flushPeriodTotal(); var sep=document.createElement('tr'); sep.innerHTML='<td colspan="5" class="hint">—</td>'; reportRows.appendChild(sep); }
        curName=r.name; periodMins=0; weekIdx=0; weekKey=null;
      }

      var wk = mondayKey(r.date);
      if(weekKey===null){ weekKey=wk; weekIdx+=1; }
      if(wk!==weekKey){ flushWeekTotal(); weekKey=wk; weekIdx+=1; }

      weekMins += r.mins; periodMins += r.mins;
      var tr=document.createElement('tr');
      tr.innerHTML='<td>'+r.name+'</td><td>'+mdy(r.date)+'</td><td>'+r.in+'</td><td>'+r.out+'</td><td class="right">'+fmt2(r.mins/60)+'</td>';
      reportRows.appendChild(tr);
    });

    if(curName){ flushWeekTotal(); flushPeriodTotal(); }
  }

  async function loadAllReports(){
    var s=await getDocs(query(collection(db,'reports'), orderBy('end','desc')));
    reportList.innerHTML=''; s.forEach(function(d){
      var data=d.data(); var st=data.start&&data.start.toDate?data.start.toDate():new Date(data.start); var en=data.end&&data.end.toDate?data.end.toDate():new Date(data.end); var gen=data.generatedAt&&data.generatedAt.toDate?data.generatedAt.toDate():null;
      var tr=document.createElement('tr');
      tr.innerHTML='<td>'+mdy(st)+'</td><td>'+mdy(en)+'</td><td>'+(gen?gen.toLocaleString():'—')+'</td><td class="right"><button class="btn-danger" data-delreport="'+d.id+'" style="height:32px;">Delete</button></td>';
      reportList.appendChild(tr);
    });
    reportList.querySelectorAll('[data-delreport]').forEach(function(b){ b.addEventListener('click', async function(){ if(!confirm('Delete this report?')) return; await deleteDoc(doc(db,'reports', b.getAttribute('data-delreport'))); await loadAllReports(); await loadLatestReport(); }); });
  }
  btnLoadLatest.addEventListener('click', loadLatestReport);

  /* Export CSV (report view) */
  btnExportTotals.addEventListener('click', function(){
    var lines=[]; lines.push(['Name','Date','Clock In','Clock Out','Daily Hours'].join(','));
    var trs=[].slice.call(reportRows.querySelectorAll('tr'));
    trs.forEach(function(tr){
      var t=[].slice.call(tr.querySelectorAll('td')).map(function(x){ return x.textContent.trim(); });
      if(t.length===5){ lines.push(t.map(function(v){ return '"'+v.replace(/"/g,'""')+'"'; }).join(',')); }
    });
    var blob=new Blob([lines.join('\n')],{type:'text/csv'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='biweekly_detailed.csv'; a.click();
  });

  /* Export CSV (Entries) — admin only */
  btnExport.addEventListener('click', function(){
    var headers=['Name','Date','Clock In','Clock Out','Day']; var lines=[headers.join(',')];
    [].slice.call(entryRows.querySelectorAll('tr')).forEach(function(tr){
      var t=[].slice.call(tr.querySelectorAll('td')).slice(0,5).map(function(td){ return td.textContent.trim(); });
      if(t.length===5) lines.push(t.map(function(v){ return '"'+v.replace(/"/g,'""')+'"'; }).join(','));
    });
    var blob=new Blob([lines.join('\n')],{type:'text/csv'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='entries_current_period.csv'; a.click();
  });
</script>
</body>
</html>
